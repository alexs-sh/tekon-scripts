#!/bin/bash
# Склейка модулей в один общий скрипт.
# Разработку удобно вести в разных файлах. Запускать удобней один большой файл.

echo -n "Build..."
OUT=tekon_master


{
echo "#!/bin/bash";
echo "";
echo "#================================================================================" ;
echo "# Info" ;
echo "#================================================================================" ;
echo "# This is autogenerated file. Please don't edit him" ;
echo "# Date: $(date)" ;
echo "# Builder: $(uname -n)";
echo "#================================================================================" ;

echo "";
echo "#================================================================================" ;
echo "# Tekon Common" ;
echo "#================================================================================" ;
echo "";
cat common.sh ;

echo "";
echo "#================================================================================" ;
echo "# Tekon Measurements" ;
echo "#================================================================================" ;
echo "";
cat measurements.sh ;

echo "";
echo "#================================================================================" ;
echo "# Tekon Archives" ;
echo "#================================================================================" ;
echo "";
cat archives.sh ; 

echo "";
echo "#================================================================================" ;
echo "# Tekon Time Synchronization" ;
echo "#================================================================================" ;
echo "";
cat timesync.sh ; 

echo "";
echo "#================================================================================" ;
echo "# Tekon Master" ;
echo "#================================================================================" ;
echo "";
cat master.sh ;
} > "${OUT}"

result=$?
if [ ${result} -eq 0 ]; then
  echo "OK"
else
  echo "Fail"
  exit 1
fi

# Убрать лишнее из результирующего файла
# Вырезать импорт файлов
echo -n "Strip..."
sed -i '/. .\/.*\.sh/d' tekon_master
result=$?
if [ ${result} -eq 0 ]; then
  echo "OK"
else
  echo "Fail"
  exit 1
fi

chmod +x "${OUT}"

# проверки:
# 1. не должно быть лишний шебангов и путей к интерпретатору
# 2. не должно быть импорты модулей
echo -n "Check..."
result=$(grep '#!/bin/.*sh' -c ${OUT})
if [ "${result}" -ne 1 ]; then
  echo "Only one !/bin/.*sh allowed"
  exit 1
fi

result=$(grep '. *.*\.sh' -c ${OUT})
if [ "${result}" -eq 0 ]; then
  echo "OK"
else
  echo "Looks like undeleted import"
  exit 1
fi

