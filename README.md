# TEKON-SCRIPTS
Набор скриптов, позволяющий организовать сбор данных со счетчиков "Тэкон", а так же обеспечить ряд сервисных функций, таких как синхронизация времени и передача данных на USB-накопитель. Для реализации обмена со счетчиками используются инструменты [**tekon-utils**](https://github.com/alexs-sh/tekon-utils). Параметры, архивы, статусы сохраняются в виде текстовых файлов в ФС.
Это позволяет легко читать, передавать и обрабатывать данные. 

## Быстрый старт

### Опрос счетчиков  


```console

tekon_master -c /tmp/defconfig

```
Запускает сбор данных со счетчика. Список параметров, архивов и заданий для синхронизации содержится в конфигурационном файле **/tmp/defconfig**


### Запись архивов на USB-накопитель  


```console

tekon_usb -d /dev/sda -m /tmp/tekon_master/usb -r /tmp/tekon_master/usb-runtime -s /tmp/tekon_master/arch

```
Запускает скрипт для записи архивов. На устройство **/dev/sda** будет записана директория **/tmp/tekon_master/arch**. 
Данные о ходе записи (шаг, код ошибки и т.п.) будут выведены в  **/tmp/tekon_master/usb-runtime**. USB-накопитель будет примонтирован к **/tmp/tekon_master/usb**
 
## Конфигурирование

Утилиты **tekon_master** может быть сконфигурированна при помощи отдельного файла, содержащего описания параметров, архивов и прочей информации. В качестве примера проект уже содержит файл **defconfig**, на основе
которого можно создать пользовательскую конфигурацию. 

Наиболее важные параметры в конфигурационном файле:

* **TEKON_ADDRESS** - сожержит адрес шлюза К-104 в формате **tekon-utils**
* **TEKON_WORKDIR** - рабочая директория, в которую будут сохранены прочитанные параметры, архивы, статусы и т.д. Рабочую директорию имеет смысл размещать в памяти при помощи **ramfs/tmpfs**.
* **TEKON_TAGS** - содержит набор параметров для чтения. Каждый парметр описывается полями: **name** и **tekon**. 
    * **name** - имя параметра. С этим именем значения параметра будут сохранятся в **TEKON_WORKDIR**. 
    * **tekon** - адрес параметра в формате **tekon-utils**.
* **TEKON_ARCH** - содержит набор архивов для чтения. Каждый архив описывается 4 полями:**name**, **parameter**, **interval**, **datetime**. 
    * **name** - имя архива. С этим именем архив будет сохранятся в **TEKON_WORKDIR**. 
    * **parameter** - адрес архива в формате **tekon-utils**. 
    * **interval** - описание интервала архива в формате **tekon-utils**. 
    * **datetime** - адрес даты и времени устройства в формате **tekon-utils**.
* **TEKON_TIMESYNC** - содержит задания по синхронизации. Каждое задание описывается 3 полями: **datetime**,  **password**, **checks**.  
    * **datetime** - адрес даты и времени устройства в формате **tekon-utils**. 
    * **password** - пароль наладчика. 
    * **checks** - список проверок выполняемых перед синхронизацией. Список проверок см. в **tekon-utils**.

## Сборка

```console
git clone https://github.com/alexs-sh/tekon-scripts.git
cd tekon-scripts
cd master 
 ./build.sh 
cd ../usb
 ./build.sh 
```

Шаг сборки является опциональным и требуется, если необходимо получить один общий скрипт. Идея в том, что разрабатывать удобней, если система разделена на модули. А использовать - когда весь функционал в одном файле. 
Данный шаг решает это противоречие, позволяя получить один результирующий файл из нескольких. 


## Запуск в Windows
Для запуска в Windows потребуется соответствующая сборка **tekon-utils** и [**MSYS**](https://osdn.net/projects/mingw/releases/). В MSYS необходимо установить пакет **msys-base-bin**. 
